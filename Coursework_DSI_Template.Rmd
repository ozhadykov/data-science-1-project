---
title: "Coursework - Data Science I"
author: "Omar Zhadykov, 220220503"
output:
  html_notebook:
    fig_width: 10
    theme: spacelab
    toc: yes
    toc_depth: 3
    toc_float: yes
  word_document:
    toc: yes
    toc_depth: '3'
  pdf_document: default
  html_document:
    fig_width: 10
    theme: spacelab
    toc: yes
    toc_depth: 3
    toc_float: yes
---

<script>
$(document).ready(function() {
  $items = $('div#TOC li');
  $items.each(function(idx) {
    num_ul = $(this).parentsUntil('#TOC').length;
    $(this).css({'text-indent': num_ul * 10, 'padding-left': 0});
  });

});
</script>

```{r setup, warning=FALSE, message=FALSE, echo=FALSE}
library(svglite)
library(knitr)
suppressPackageStartupMessages(library(data.table))
library(ggplot2)
knitr::opts_chunk$set(dev = "svglite")

# Put your dataset in the same folder as your R file. This code will set your working directory for this notebook to the folder where the R file is stored. This way I can rerun your code without modifications.

library(rstudioapi)
setwd(dirname(getActiveDocumentContext()$path))
```

# Introduction

This coursework focuses on housing prices, with the main objective being to predict the price of a property based on various inputs. The inputs include features such as the area, the number and types of rooms, and additional factors like the availability of a main road, hot water heating, and more.

The dependent variable is the price, as it is the primary concern for most people searching for a house. The goal of this work is to predict the price based on diverse inputs, which consist of mixed data types, such as:

  - Numerical values
  - Text-based responses like "yes" or "no"
  - Categories for furnishing status, including "furnished," "semi-furnished," or "non-furnished."

This project addresses a regression problem because the objective is to predict a numeric valueâ€”in this case, the price of the property.

# Collection / Preparation 

Now we are going to import our dataset into this project.

```{r}
dt_houses <- fread(file = "./datasets/Regression_set.csv")
```

<br>
I would like to check, if i have some nullish data in my dataset. I think it is a good idea to go through all rows and colums and check, if there is a NA. I want to check it with built-in function in R *complete.cases(data_table)*. This function returns TRUE or FALSE if row contains a NA value.

```{r}
nas <- dt_houses[!complete.cases(dt_houses)]
nas
```

That looks great, now we can explore our dataset :)

# Exploration

Before we will explore our data, I want to import all libraries, which we will probably use:

```{r}
library(data.table)
library(ggcorrplot)
library(ggExtra)
library(ggplot2)
library(ggridges)
library(ggsci)
library(ggthemes)
library(RColorBrewer)
library(svglite)
library(viridis)
library(scales)
library(rpart)
library(rpart.plot)
```

I found some helpful functions in R, so we could have a look on our data. We will start with a structure, than we will get some statistic data and take a *head()* of the data

```{r}
str(dt_houses)
```
<br>
Statistic data:
```{r}
summary(dt_houses[, .(price, area, bedrooms, bathrooms, stories, parking)])
```

<br>
and this is a sample of our dataset:

```{r}
head(dt_houses)
```

I would like to start from density of a main values, which are from my domain knowledge are important in price of the properties

We will start with price density: 

```{r}
ggplot(data = dt_houses, aes(x = price)) + 
  geom_density(fill="#f1b147", color="#f1b147", alpha=0.25) + 
  labs(
    x = 'Price',
    y = 'Density'
  ) +
  geom_vline(xintercept = mean(dt_houses$price), linetype="dashed") + 
  scale_x_continuous(labels = label_number(scale = 1e-6, suffix = "M")) + 
  theme_minimal() + 
  theme(axis.line = element_line(color = "#000000"))
```

Also it would be greate to have a look at area density:

```{r}
ggplot(data = dt_houses, aes(x = area)) + 
  geom_density(fill="#f1b147", color="#f1b147", alpha=0.25) + 
  labs(
    x = 'Price',
    y = 'Density'
  ) +
  theme_minimal() + 
  theme(axis.line = element_line(color = "#000000"))
```


<br>
This is interesting, how does area affect price of the house. We will plot it with points, where price is on the y-axis and area on x-axis.

```{r}
ggplot() + 
  geom_point(data = dt_houses, aes(x = area, y = price, color = parking)) +
  scale_y_continuous(labels = label_number(scale = 1e-6, suffix = "M")) + 
  theme_minimal() + 
  theme(axis.line = element_line(color = "#000000"))
```

This looks nice, and it is also logical, more space, higher price.

But, now I have the simplest idea, how does amount of bedrooms correlates with the price.

```{r}
ggplot(data = dt_houses, aes(x = factor(bedrooms), y = price)) +
  geom_boxplot() + 
  theme_minimal() 
```

We can see, that on average, more bedrooms, means higher price, but I think there is not really strong relationship between this two variables.

Also it would be great to take a look at a bedrooms histogram:

```{r}
ggplot(data = dt_houses, aes(x = bedrooms)) + 
  geom_histogram(fill="#2f9e44", color="#2f9e44", alpha=0.25) + 
  geom_vline(xintercept = mean(dt_houses$bedrooms), linetype="dashed") + 
  theme_minimal() + 
  theme(axis.line = element_line(color = "#000000"))
```
Also I want to show you the mean of the bedrooms:
```{r}
mean(dt_houses$bedrooms)
```


Here we can see, that the most of the properties tend to have 2, 3 or 4 rooms. 

Let's also have a look at histogram of stroies: 

```{r}
ggplot(data = dt_houses, aes(x = stories)) + 
  geom_histogram(fill="#2f9e44", color="#2f9e44", alpha=0.25) + 
  geom_vline(xintercept = mean(dt_houses$stories), linetype="dashed") + 
  theme_minimal() + 
  theme(axis.line = element_line(color = "#000000"))
```

```{r}
mean(dt_houses$stories)
```

It is interesting how much real estate furnished or not

```{r}
ggplot(data = dt_houses, aes(x = factor(furnishingstatus), fill = factor(furnishingstatus))) + 
  geom_bar(color="#ced4da", alpha=0.25) + 
  scale_fill_viridis_d(option = "D") + 
  labs(title = "Bar Chart with Different Colors", 
       x = "Furnishing Status", 
       y = "Count") + 
  theme_minimal() + 
  theme(axis.line = element_line(color = "#000000"))
```

We can see, that most of the houses are semi-furnished.

Now, it would be great, to look at price and area distribution in differently furnished properties


```{r}
ggplot(data = dt_houses, aes(y = price, x = area)) + 
  geom_point(data = dt_houses, aes(y = price, x = area, color = bedrooms)) +
  geom_hline(yintercept = mean(dt_houses$price), linetype='dashed') + 
  facet_grid(.~furnishingstatus) +
  scale_y_continuous(labels = label_number(scale = 1e-6, suffix = "M")) +
  scale_color_distiller(type = "seq", palette = "Greens") +
  theme_minimal() + 
  theme(axis.line = element_line(color = "#000000"))
```

Also, on average, you can notice, that unfurnished houses, are less expencive.

We can also take a look on some pie charts:

```{r}

dt_mainroad_counts <- as.data.frame(table(dt_houses$mainroad)) #table() - creates frequency table
colnames(dt_mainroad_counts) <- c("mainroad_status", "count")
dt_mainroad_counts$percentage <- round(dt_mainroad_counts$count / sum(dt_mainroad_counts$count) * 100, 1)

ggplot(data = dt_mainroad_counts, aes(x = "", y = count, fill = mainroad_status)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar("y", start = 0) +
  geom_text(aes(label = paste0(percentage, "%")), 
            position = position_stack(vjust = 0.5), color = "white", size = 4) +  
  theme_void() +  
  scale_fill_manual(values = c("#F1B147", "#47B1F1")) + 
  labs(
    title = "Distribution of Mainroad Status",
    fill = "Mainroad Status"
  )

```


I think that would be enough exploration and we can start with our first model.

# Models 1 & 2

First, I would like to start pretty simple with linear model.

I consider to take this variables in my model: area, bedrooms, bathrooms, hotwaterheating, airconditioning, stories, mainroad, parking and furnishingstatus.

## Linear model

I will use lm function in R to find needed beta coefficients and create my model

```{r}
price_lm <- lm(formula = price ~ area + bedrooms + hotwaterheating + airconditioning + stories + mainroad + parking + furnishingstatus + bathrooms + guestroom + basement + prefarea, data = dt_houses)

summary(price_lm)
```

We got 0.64 R-squared, which is not that bad for a model just made up. But that's not all, I will try to do better here, but first, another model.

But I would like to measure performance of my models with MSE, so I will calculate MSE for linear model.

```{r}
price_lm_mse <- mean(price_lm$residuals^2)

price_lm_mse
```


## Tree Model

I think this model could perform better, because there some variables which can affect this model not only linearly, but the other way, in this case tree model can show better performance

```{r}
prices_tree <- rpart(data = dt_houses, formula = price ~ area + bedrooms + hotwaterheating + airconditioning + stories + mainroad + parking + furnishingstatus + bathrooms + guestroom + basement + prefarea, method = 'anova')

prp(prices_tree, digits = -3)
```

```{r}
printcp(prices_tree)
```

```{r}
prices_tree
```

```{r}
plotcp(prices_tree)
```


```{r}
prices_tree_min_cp <- prices_tree$cptable[which.min(prices_tree$cptable[, "xerror"]), "CP"]
model_tree <- prune(prices_tree, cp = prices_tree_min_cp )
prp(prices_tree,digits = -3)
```

after we pruned the tree, let's calculate the MSE for the tree model


```{r}
prices_tree_pred <- predict(prices_tree, dt_houses[, c("area","bathrooms", "bedrooms", "hotwaterheating", "airconditioning", "parking", "stories", "mainroad", "furnishingstatus", "guestroom", "basement", "prefarea")])
prices_tree_mse <- mean((dt_houses$price - prices_tree_pred)^2)

prices_tree_mse
```


## Comparing two models

price linear model has a MSE of 

```{r}
price_lm_mse
```

price tree model has a MSE of 

```{r}
prices_tree_mse
```


It is surprising for me, as for a person who does not have a lot of experience in modelling, that linear model performs better than tree model by approx. 22%. 

```{r}
100 - price_lm_mse / prices_tree_mse * 100
```


# Feature Engineering

Here I would like to try all ideas and observations, which I've had through my course work. I've seen two columns, such as "bedrooms" and "bathrooms", they store numerical value, amount of this kind of rooms. It makes sense for me to create a new column "room_count", because it may have bigger impact on the performance.

```{r}
dt_houses[, 'room_count' := bathrooms + bedrooms]
```


Let's try Model with a new variable

```{r}
price_lm_2 <- lm(formula = price ~ area + bedrooms + hotwaterheating + airconditioning + stories + mainroad + parking + furnishingstatus + bathrooms + guestroom + basement + prefarea + room_count, data = dt_houses)

summary(price_lm_2)
mean(price_lm_2$residuals^2)
```

this is absolutely the same.

what if we will try to bring the area variable closer to Gaussian with log transformation

```{r}
dt_houses[, area_log := log(area)]
```


little visualisation:

```{r}
ggplot(data = dt_houses, aes(x = area_log)) + 
  geom_density(fill="#f1b147", color="#f1b147", alpha=0.25) + 
  labs(
    x = 'Price',
    y = 'Density'
  ) +
  theme_minimal() + 
  theme(axis.line = element_line(color = "#000000"))
```

and try model again :)

```{r}
price_lm_2 <- lm(formula = price ~ area + bedrooms + hotwaterheating + airconditioning + stories + mainroad + parking + furnishingstatus + bathrooms + guestroom + basement + prefarea + area_log, data = dt_houses)

summary(price_lm_2)
mean(price_lm_2$residuals^2)
```

it performs approx 0.4% better, if we look at R-Squared error. MSE also got for 0.2e+12 better.

```{r}
dt_houses_2 <- dt_houses

#dt_cars[, noAWD := 0][AWD==0, noAWD :=1]

dt_houses_2[, test_col := 0][guestroom == 'no', test_col := 1]

price_lm_2 <- lm(formula = price ~ area + bedrooms + hotwaterheating + airconditioning + stories + mainroad + parking + furnishingstatus + bathrooms + guestroom + basement + prefarea + test_col, data = dt_houses_2)

summary(price_lm_2)
mean(price_lm_2$residuals^2)
```


Engineer a minimum of two new features based on your data exploration or on theoretical considerations. Add these features to your models and reevaluate their performance on the same performance metrics as before.

***




